#!/usr/sbin/nft -f
# {{ ansible_managed }}

flush ruleset

table inet filter {
  chain input_ipv4 {
    icmp type echo-request limit rate 10/second burst 4 packets accept
  }

  chain input_ipv6 {
    icmpv6 type { nd-neighbor-solicit, nd-router-advert, nd-neighbor-advert } accept
    icmpv6 type echo-request limit rate 10/second burst 4 packets accept
  }

  chain input {
    type filter hook input priority filter; policy drop;

    iifname lo accept

    ct state vmap { established : accept, related : accept, invalid : drop }

    meta protocol vmap { ip : jump input_ipv4, ip6 : jump input_ipv6 }

    tcp dport ssh ct state new limit rate 15/minute accept
  }

  chain forward {
    type filter hook forward priority filter; policy drop;
  }

  chain output {
    type filter hook output priority filter; policy accept;
  }
}
