# {{ ansible_managed }}

user www-data;
pid /run/nginx.pid;
worker_processes {{ nginx_worker_processes }};
worker_rlimit_nofile {{ nginx_worker_rlimit_nofile }};

error_log /var/log/nginx/error.log warn;

include /etc/nginx/modules-enabled/*.conf;

events {
  worker_connections {{ nginx_worker_connections }};
}

http {
  sendfile on;
  tcp_nopush on;
  server_tokens off;
  types_hash_max_size {{ nginx_types_hash_max_size }};
  types_hash_bucket_size {{ nginx_types_hash_bucket_size }};

  include /etc/nginx/mime.types;
  default_type application/octet-stream;
  charset utf-8;
  charset_types
    text/cache-manifest
    text/calendar
    text/css
    text/csv
    text/html
    text/javascript
    text/markdown
    text/plain
    text/vcard;

  log_format main '$remote_addr - $remote_user [$time_local] '
                  '"$request" $status $body_bytes_sent '
                  '"$http_referer" "$http_user_agent" '
                  '"$http_x_forwarded_for"';

  log_format cloudflare '$remote_addr - $remote_user [$time_local] '
                        '"$request" $status $body_bytes_sent '
                        '"$http_referer" "$http_user_agent" '
                        '$http_cf_ray '
                        '$http_cf_connecting_ip $http_x_forwarded_for '
                        '$http_cf_ipcountry';

  log_not_found off;
  access_log /var/log/nginx/access.log {{ nginx_coudflare | ternary('cloudflare', 'main') }};

  ssl_protocols TLSv1.3;
  ssl_ecdh_curve X25519:prime256v1:secp384r1;
  ssl_prefer_server_ciphers off;
  ssl_session_tickets off;

  {# add_header Strict-Transport-Security "max-age=63072000" always;
  keepalive_timeout {{ nginx_keepalive_timeout }}; #}

  gzip on;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_vary on;
  gzip_types
    text/cache-manifest
    text/calendar
    text/css
    text/html
    text/javascript
    text/markdown
    text/plain
    text/vcard
    text/vtt
    image/svg+xml
    image/x-icon
    font/otf
    font/ttf
    application/atom+xml
    application/geo+json
    application/json
    application/ld+json
    application/manifest+json
    application/mathml+xml
    application/rdf+xml
    application/rss+xml
    application/wasm
    application/xhtml+xml
    application/xml
    application/xslt+xml
    application/vnd.ms-fontobject;

  include /etc/nginx/conf.d/*.conf;
  include /etc/nginx/sites-enabled/*;
}
